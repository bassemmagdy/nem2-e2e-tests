---
# this playbook is supposed to:
# 1. copy monitor-containers script onto all peer nodes into ~/symbol-testnet/utilities/bin/bash/monitor-containers.sh
# 2. Make it executable
# 3. (rename nohup.out if it exists) 
# 4. Start it in the background for x+1 hours
# 5. stop any currently running pumba containers
# 6. start new pumba container to kill the peer node with an interval of x minutes
# 7. If possible, set timeout for the pumba container also for x hours

- hosts: peer*,beacon*
  remote_user: ubuntu
  tasks:
    - name: install python-pip
      apt:
        state: latest
        name: python3-pip
      become: yes
    - name: install docker python library required by ansible
      pip:
        name:
        - docker
    - name: copy container monitoring files
      copy:
        src: ./scripts/
        dest: ~/symbol-testnet/utilities/monit-cont/
        force: yes
        owner: ubuntu
        mode: '754'
      with_fileglob: '*monitor-containers*'
    - name: build the container monitoring image
      docker_image:
        name: tech-bureau/monit-cont:latest
        build:
          dockerfile: ~/symbol-testnet/utilities/monit-cont/Dockerfile-monitor-containers
          path: ~/symbol-testnet/utilities/monit-cont/
          pull: yes
          rm: yes
        source: build
        state: present
    - name: start container monitoring
      docker_container:
        name: monit-cont_1
        state: started
        image: tech-bureau/monit-cont:latest
        detach: yes
        log_driver: json-file
        output_logs: yes
        command: --end-time {{ MONITOR_END_TIME }} --sleep-interval {{ MONITOR_INTERVAL}} {{ CONTAINERS_TO_KILL }}
        volumes:
        - /var/run/docker.sock:/var/run/docker.sock:rw
        restart_policy: always
        restart_retries: 5
    - name: "List all known variables and facts"
      debug:
        var: hostvars[inventory_hostname]
    - name: identify any running pumba containers
      shell: docker ps --filter ancestor=gaiaadm/pumba | grep -q gaiaadm/pumba && echo -n "EXISTS"
      register: pumba_cont
    - name: stop any running pumba containers
      shell: docker ps -q --filter ancestor=gaiaadm/pumba | xargs docker stop
      when: "'EXISTS' in pumba_cont.stdout"
      changed_when: "'EXISTS' in pumba_cont.stdout"
    - name: start pumba
      docker_container:
        name: pumba_1
        state: started
        image: gaiaadm/pumba
        detach: yes
        log_driver: json-file
        output_logs: yes
        command: --log-level=debug --interval={{ PUMBA_INTERVAL }} --json kill --signal=SIGKILL {{ CONTAINERS_TO_KILL }}
        volumes:
        - /var/run/docker.sock:/var/run/docker.sock:rw
        restart_policy: always
        restart_retries: 5
    